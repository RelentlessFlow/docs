# 二、网络层

[toc]

## 一、概述

网络层IP协议相关

- IP协议	子网划分	简单路由过程

网络层其他协议：

- ARP协议与RARP协议、ICMP协议

IP的路由算法：

- 路由概述	内部网关路由	外部网关路由

## 二、IP协议详解

### 1. 虚拟互联网络

- 实际的计算机网络是错综复杂的
- 物理设备通过使用IP协议，屏蔽了物理网络之间的差异
- 当网络中的主机使用IP协议连接时，则无需关注网络细节
- IP协议使得复杂的实际网络变为一个虚拟互连的网络
- IP协议使得网络层可以屏蔽底层细节而专注网络层的数据转发
- IP协议解决了在虚拟网络中数据报传输路径的问题

### 2. IP协议

<img src="https://md-1304276643.cos.ap-beijing.myqcloud.com//PicGo/image-20220320004736425.png" alt="image-20220320004736425" style="zoom:40%;" />

- 版本:占4位，指的是IP协议的版本，通信双方的版本必须一致，当前主流版本是4，即IPv4， 也有IPv6
- 首部位长度:占4位，最大数值为15,表示的是IP首部长度，单位是"32位字" (4个字节)，即IP首 部最大长度为60字节
- 总长度:占16位,最大数值为65535，表示的是IP数据报总长度(IP首部+IP数据)
- TTL:占8位，表明IP数据报文在网络中的寿命，每经过- -个设备，TTL减1， 当TTL=0时，网络设备必须丢弃该报文
- 协议:占8位，表明IP数据所携带的具体数据是什么协议的(TCP、 UDP等)
- 首部校验和:占16位，校验IP首部是否有出错

<img src="https://md-1304276643.cos.ap-beijing.myqcloud.com//PicGo/image-20220320004755070.png" alt="image-20220320004755070" style="zoom:40%;" />

## 三、IP转发流程

数据的每次转发，都会两次经过4层网络协议的转换:

1. A发送B:网络层-》 链路层-》物理层
2. B接受:物理层-》链路层-》网络层.
3. B发送C:网络层-》链路层-》物理层
4. C接受:物理层-》链路层-》网络层

始于网络层也终于网络层。

先通过网络层查询ip路由表，找到下一跳，

再通过MAC找到局域网中的具体ip。

## 四、ARP协议与RARP协议

1. ARP/RARP协议是TCP/IP协议栈里面基础的协议，它主要完成网络层和数据链路层配合的工作，理解它有助于理解网络分层的细节
2. 如果缓存表中已有IP地址映射的MAC地址信息，则直接使用该信息，如果没有映射信息，则会将目标IP广播给所有设备,接收到广播的设备都会返回一个数据包，再将返回记录到ARP缓存表中

### 1. ARP缓存表

<img src="https://md-1304276643.cos.ap-beijing.myqcloud.com//PicGo/image-20220320010913351.png" alt="image-20220320010913351" style="zoom:40%;" />

### 2. ARP协议帧

<img src="https://md-1304276643.cos.ap-beijing.myqcloud.com//PicGo/image-20220320011017864.png" alt="image-20220320011017864" style="zoom:40%;" />

### 3. [ARP](https://so.csdn.net/so/search?q=ARP&spm=1001.2101.3001.7020)的工作原理 

ARP用于已知本端IP地址和硬件地址以及对端IP地址的情况下，求解对端的IP地址，其工作原理简示如下：  

- A首先发送广播消息请求其对应目的IP地址的硬件地址是多少？同时在该广播消息中还附带自己的IP地址和硬件地址。  
- B接受到该广播包后，取出A的IP地址和硬件地址，将其添加到[地址映射](https://so.csdn.net/so/search?q=地址映射&spm=1001.2101.3001.7020)表中。同时返回单播响应，响应包中包含B的IP地址和硬件地址。  
- A收到响应，取出B的IP地址和硬件地址，将其添加到地址映射表中。  
- 之后设备A和B就可以正常进行数据传送了。  

### 4. RARP的工作原理  

RARP用于已知硬件地址，而IP地址未知的情况。其工作原理简示如下：  

- A首先发送广播消息请求其对应目的硬件地址的IP地址是多少？同时在该广播消息中还附带自己的硬件地址。 
- B接受到该广播包后，返回单播响应，响应包中包含B的IP地址和硬件地址（常常还包含A的IP地址，这是为了减少ARP的解析）。  
- A收到响应，取出B的IP地址和硬件地址，将其添加到地址映射表中。  
- 之后设备A和B就可以正常进行数据传送了

## 五、IP地址子网划分

### 1. IP地址的分类，如何划分，以及计算各类地址支持的主机数。

- A类地址：首位位0，1.0.0.1~~126.255.255.254；主机号24位
- B类地址：首位为10，128.0.0.1~~·191.255.255.254：主机号16位。
- C类地址：首位为 110，192.0.0.1~~223.255.255.254;主机号 8 位
- D 类地址(多播地址，也叫做组播地址):首位为 1110，224.0.0.1~~239.255.255.254
- E 类地址:此类地址是保留地址，首位为 11110，240.0.0.1~~254.255.255.254

