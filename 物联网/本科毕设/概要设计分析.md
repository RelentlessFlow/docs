# 概要设计分析

## 一、系统的功能性需求

### 一、图书馆门口计算机

1. 15分钟生成一个小程序码（二维码）
2. 学生扫描后即可进入预约座位小程序

### 二、河北传媒学院图书馆预约座位小程序

1. 登录界面
   1. 输入学号、密码即可进入房间选择界面
2. 注册界面
   1. 输入学号、姓名、密码即可跳转登录界面
3. 主界面
   1. 通过底部导航栏将应用功能进行拆分，分为 预约、我的
4. 预约界面
   1. 房间选择界面
      1. 向学生展示房间列表，以供学生进一步选择座位号
   2. 座位选择界面
      1. 向学生展示当前可预约时段，若当前时间小于8点30分，则向学生提示最早预约时段为8点30分至10点30分，若当前时间大于20点30分，则向学生提示最晚预约离馆时间为22:00
      2. 展示当前房间的座位列表，当用户选择座位后，提示预约成功，进入下一级界面
   3. 学习中界面
      1. 第一行展示预约开始时间和已学习时长
      2. 第二行展示预约结束时间和剩余学习时长
      3. 在顶部显示消息提醒，通过判断当前时间，显示不同的消息（每5秒刷新一次）
         1. 若当前时间与预约开始时间距离大于n * 1小时，小于n * 1小时10分钟，则展示“**管理老师会不定期巡视，出现1次半小时以上时间不在座位上的情况，即属于违规占座**”
         2. 若当前时间与预约开始时间距离大于1小时50分钟，小于2小时，则展示“**读者如需继续使用座位需要再次到读报机或计算机扫二维码预约座位**”
      4. 每30秒判断一次，若当前时间大于预约结束时间，则弹窗”当前预约时段已结束，读者如需继续使用座位需要再次到读报机或计算机扫二维码预约座位，请立刻离开座位“，点击确定后退出微信小程序。
      5. ~~在底部展示续约按钮，若当前时间与结束时间大于10分钟，则显示可续约时间；若当前时间与结束时间小于10分钟，则显示立即续约（可选）~~
5. 我的界面
   1. 展示用户资料卡
   2. 修改密码
   3. 关于

### 三、河北传媒学院图书馆预约座位管理端

1. 登录界面
   1. 输入用户名、密码登录管理端后台
2. 管理端后台界面
   1. 通过底部导航栏将应用功能进行拆分，分为 座位管理、违规情况、个人中心
   2. 座位管理界面
      1. 房间选择界面，流程同学生端
      2. 当前房间座位列表展示，主要展示座位是否为空，显示预约开始时间和结束时间，当前距离结束时间，当前距离开始时间
      3. 管理员可以通过点击座位号，弹窗展示是否记录XXX学生已经违规，点击是，即向学生发送违规通知（包含违规记录时间与座位号），并提示发送成功。
   3. 违规情况界面
      1. 展示违规学生列表，展示学号，姓名，违规次数，以及清零按钮
      2. 展示违规全部清零按钮
      3. 展示搜索框，支持姓名检索

## 二、数据库设计

### 一、学生信息stu

ID、姓名、学号

### 二、用户表user

ID、用户名username、密码password、权限role [reader，admin]

### 三、读者表reader

ID、学号num、真实姓名name、违规次数violate、是否失信disable、用户ID user_id

### 四、房间表room

ID、名称name、类型type【write，book，corridor】，行数row，大小size，偏移offset，每行座位数row_size、排序order_t

### 五、座位表site

ID、座位号num、预约时间reserve_time，签退时间signout_time、预约人reader_id、桌子group、房间号room_id、排序order_t

### 六、违约信息记录表violate

ID、读者reader_id、管理员admin_id、违约时间violate_time、房间号room_id、座位号site_id

## 三、技术栈分析

考虑到系统数据需要被多个小程序以及其他客户端调用，建议采用独立的后端服务和数据库

服务器：阿里云ECS 双核4GB服务器 590/年

数据库：MySQL8.0数据库

后端服务：

​	采用经过广泛市场检验的基于Node.js与Express的Nest.js框架与TypeORM框架，主要开发语言为TypeScript（JavaScript的超集）

前端服务：

​	在图书馆二维码端，可以采用基于Web、React技术的网页应用显示二维码

​	在学生端以及管理端，采用微信小程序作为前端。

### 技术难点分析

#### 1、 图书馆门口计算机15分钟生成一个小程序码（二维码）

图书馆门口计算机跑一个网页或者Electron客户端，在网页端每15分钟自动向服务器请求生成新的二维码，并进行展示。

服务器生成新的二维码API

1. Nest.js 配合 JWT 生成随机Token，将Token存入Redis，设置15分钟过期时间。

2. 向腾讯服务器发送请求申请新的小程序码，请求中带有Token令牌内容。

   https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/qrcode-link/qr-code/getUnlimitedQRCode.html

3. 将腾讯服务器返回的图片数据返回

#### 2、后端部署

首先后端部署包括Web服务器的部署，MySQL数据库的部署Redis缓存数据库的部署以及HTTPS的部署

至少需要一台双核 4GB的ECS服务器

Nest.js的部署较为复杂，需要1天至2天时间

HTTPS证书的申请需要实名验证以及审核，需要3天左右
