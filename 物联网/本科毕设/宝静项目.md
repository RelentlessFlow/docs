# 图书馆微信小程序开发需求分析

## 一、需求解读

### 第一项：读者进馆扫描读报机或计算机上生成选座二维码。（更新时间每十五分钟）

解读：

​	首先需要扫描二维码登录微信小程序，学生在外面无法访问微信小程序，访问微信小程序需要配合二维码验证

实现：

1. Nest.js配合Redis配合JWT，生成唯一Token，Token过期时间为15分钟，将Token转换为二维码
2. 生成二维码参考https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/qrcode-link/qr-code/getUnlimitedQRCode.html
3. 二维码扫描完成后，在App onLunch()生命周期函数中验证入口参数合法性
4. 若合法，向后端发送请求验证Redis中是否存在Token，若存在，则继续登录流程，若不存在，则提示用户二维码已经过期，请重新扫描 二维码，并给予用户扫描二维码的快捷按钮。
5. 若不合法，则表示用户没有通过二维码扫描的方式进入，给予用户请在图书馆扫描微信二维码后使用的提示，然后强制关闭小程序。

### 第二项：登录界面，初次登录需要输入姓名和学生证号

解读：

​	扫描二维码以后，若用户从未注册过，显示一个姓名、学生证号的表单，下面一个按钮，立即注册，注册完毕后跳转下一级界面。

注册逻辑后端实现：

1. 设计一个学生信息表，先包含ID、学号、姓名三个字段
2. 将学校的信息导入进预先设计好的数据表
3. 再设计一个图书馆读者表，先包含ID、学号、姓名三个字段
4. 使用Nest.js设计控制器，接受@Body参数的Post请求，RegisterDTO包含「stu_num，name，password」，LoginDTO包含（stu_num，password）
5. 注册成功控制器返回 用户基本信息。
6. 登录成功控制器返回 Token和用户基本信息

微信小程序端实现：

1. App onLunch函数：通过判断 localStrorage 中 是否存在token，若存在，则向服务器拉取最新的用户信息，跳转至下一级界面；若不存在，则跳转至注册界面
2. 登录界面
   1. onReady函数，从本地localStrorage中查看username与password，若存在，则将表单进行刷新
   2. 用户点击登录后，将用户名与密码通过Ajax发送至服务端
      1. 若返回结果为Token字符串，则进入下一流程。
      2. 若返回结果为false，则提示用户学号或密码错误，请重新输入
   3. 记住密码
      1. 若勾选记住密码，则在登录事件中将学号和密码存入loadStrorage
3. 注册界面
   1. 大体逻辑同登录界面，注册成功后将学号密码存入loadStrorage直接跳转至登录界面
   2. 注册时需要从学生信息表中验证学号、姓名以及密码的合法性
   3. 若已经注册，则提示用户您已经注册，跳转至登录页



